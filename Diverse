-- LocalScript (StarterPlayerScripts)
local Players = game:GetService("Players")
local GuiService = game:GetService("GuiService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local VirtualUser = game:GetService("VirtualUser")
local player = Players.LocalPlayer

-- ================= GUI =================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoBotGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 250, 0, 150)
mainFrame.Position = UDim2.new(0, 50, 0, 50)
mainFrame.BackgroundColor3 = Color3.fromRGB(255,255,255)
mainFrame.BackgroundTransparency = 0.9
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local uICorner = Instance.new("UICorner")
uICorner.CornerRadius = UDim.new(0, 20)
uICorner.Parent = mainFrame

local uiStroke = Instance.new("UIStroke")
uiStroke.Color = Color3.fromRGB(255,255,255)
uiStroke.Thickness = 2
uiStroke.Transparency = 0.5
uiStroke.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 0, 40)
title.Position = UDim2.new(0, 10, 0, 10)
title.BackgroundTransparency = 1
title.Text = "Diverse piece"
title.TextColor3 = Color3.fromRGB(0,0,0)
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = mainFrame

-- ================= ตัวแปรควบคุม =================
getgenv().AutoBotEnabled = false
getgenv().pressE = false
getgenv().loopSkill = false
getgenv().gun = false
getgenv().autoEquipSaber = false

-- Farm Gem Button + Status
local button = Instance.new("TextButton")
button.Size = UDim2.new(1, -20, 0, 40)
button.Position = UDim2.new(0, 10, 0, 70)
button.BackgroundColor3 = Color3.fromRGB(255,255,255)
button.BackgroundTransparency = 0.7
button.TextColor3 = Color3.fromRGB(0,0,0)
button.Font = Enum.Font.Gotham
button.TextSize = 16
button.Text = "Farm Gem 🔴"

local uICornerBtn = Instance.new("UICorner")
uICornerBtn.CornerRadius = UDim.new(0,12)
uICornerBtn.Parent = button
button.Parent = mainFrame

button.MouseButton1Click:Connect(function()
    getgenv().AutoBotEnabled = not getgenv().AutoBotEnabled
    getgenv().pressE = getgenv().AutoBotEnabled
    getgenv().loopSkill = getgenv().AutoBotEnabled
    getgenv().gun = getgenv().AutoBotEnabled
    getgenv().autoEquipSaber = getgenv().AutoBotEnabled

    if getgenv().AutoBotEnabled then
        button.Text = "Farm Gem 🟢"
    else
        button.Text = "Farm Gem 🔴"
    end
end)

-- ================= ฟังก์ชัน Equip =================
local function EquipWithRemote(toolName)
    local tool = player.Backpack:FindFirstChild(toolName) or player.Character:FindFirstChild(toolName)
    if tool and tool:IsA("Tool") then
        local success, remote = pcall(function()
            return ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Events"):WaitForChild("Input")
        end)
        if success and remote then
            pcall(function()
                remote:FireServer("Equip", tool)
            end)
        end
        player.Character.Humanoid:EquipTool(tool)
    end
end

-- ================= Loop Auto-Hold Saber =================
spawn(function()
    while true do
        if getgenv().autoEquipSaber and player.Character then
            EquipWithRemote("Saber")
        end
        task.wait(1)
    end
end)

-- ================= Auto Equip ตอน Respawn =================
player.CharacterAdded:Connect(function()
    task.wait(1)
    if getgenv().autoEquipSaber then
        EquipWithRemote("Saber")
    end
end)

-- ================= กด E อัตโนมัติ =================
spawn(function()
    while true do
        if getgenv().pressE then
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
            task.wait(0.05)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
            task.wait(0.5)
        end
        task.wait()
    end
end)

-- ================= Focus + กด Enter รับเควส =================
spawn(function()
    while true do
        local success, acceptButton = pcall(function()
            return player.PlayerGui.Display.Dialogue.Container.Main.ScrollingFrame:FindFirstChild("Choice_Accept")
        end)

        if success and acceptButton then
            GuiService.SelectedObject = acceptButton
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
            task.wait()
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
        end
        task.wait(0.1)
    end
end)

local function isQuestGUIOpen()
    local success, acceptBtn = pcall(function()
        return player.PlayerGui.Display.Dialogue.Container.Main.ScrollingFrame:FindFirstChild("Choice_Accept")
    end)
    return success and acceptBtn ~= nil
end

-- ================= ฟังก์ชันยิงสกิลผ่าน Remote =================
local function useSkillRemote(skillKey, targetPosition)
    local tool = player.Character:FindFirstChild("Saber")
    if not tool then return end

    local args = {
        "Tool",
        tool,
        skillKey,
        targetPosition
    }
    local success, remote = pcall(function()
        return ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Events"):WaitForChild("Input")
    end)
    if success and remote then
        pcall(function()
            remote:FireServer(unpack(args))
        end)
    end
end

-- ================= Loop Auto Skill (เช็คบอสเกิดก่อน) =================
spawn(function()
    while true do
        if getgenv().loopSkill and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local bossExists = false
            for _,v in pairs(workspace.Enemies:GetChildren()) do
                if v.Name == "Shinigami [Level 1000]" and v:FindFirstChild("HumanoidRootPart") then
                    bossExists = true
                    break
                end
            end

            if bossExists then
                useSkillRemote("C", Vector3.new(1114.8075, 16.4287, -1152.3626))
                task.wait(0.2)
                useSkillRemote("X", Vector3.new(1114.6445, 16.4287, -1159.3775))
                task.wait(0.2)
                useSkillRemote("Z", Vector3.new(1111.6776, 16.7521, -1179.9415))
            end
        end
        task.wait(1)
    end
end)

-- ================= ตรวจสอบ AutoFarm ทุก 5 วินาที + อัพเดทปุ่ม GUI =================
spawn(function()
    while true do
        if not getgenv().AutoBotEnabled then
            getgenv().AutoBotEnabled = true
            getgenv().pressE = true
            getgenv().loopSkill = true
            getgenv().gun = true
            getgenv().autoEquipSaber = true

            -- อัพเดทปุ่ม GUI
            if button and button:IsA("TextButton") then
                button.Text = "Farm Gem 🟢"
            end

            print("AutoBot ถูกเปิดอัตโนมัติ")
        end
        task.wait(5)
    end
end)

-- ================= เคลื่อนที่ไปยังบอส =================
spawn(function()
    while true do
        if getgenv().gun and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character.HumanoidRootPart
            for _,v in pairs(workspace.Enemies:GetChildren()) do
                if v.Name == "Shinigami [Level 1000]" then
                    local Mon = v:FindFirstChild("HumanoidRootPart")
                    if Mon then
                        hrp.CFrame = Mon.CFrame * CFrame.new(0,0,5)
                    end
                end
            end
        end
        task.wait()
    end
end)

-- ================= Armament Haki =================
local function isHakiEnabled()
    local char = workspace.Characters:FindFirstChild(player.Name)
    if not char then return false end
    return char:FindFirstChild("Armament Haki") ~= nil
end

local function activateArmament()
    local args = { "Armament Haki" }
    ReplicatedStorage:WaitForChild("Remotes")
        :WaitForChild("Events")
        :WaitForChild("Input")
        :FireServer(unpack(args))
end

spawn(function()
    while true do
        if getgenv().AutoBotEnabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if not isHakiEnabled() then
                activateArmament()
            end
        end
        task.wait(1)
    end
end)

-- ================= Quest Teleport =================
local questCFrame = CFrame.new(
    1207.90942, 19.3573723, -1060.38269,
    0.707134247, -0, -0.707079291,
    0, 1, -0,
    0.707079291, 0, 0.707134247
)

spawn(function()
    while true do
        if getgenv().AutoBotEnabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character.HumanoidRootPart
            local distance = (hrp.Position - questCFrame.Position).Magnitude
            if distance > 5 then
                hrp.CFrame = questCFrame
            end
        end
        task.wait(1)
    end
end)
